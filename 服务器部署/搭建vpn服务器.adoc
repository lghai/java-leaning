= 基于centos 搭建VPN(shadowsocks+serverspeeder)

// Settings:
:source-highlighter: prettify
:experimental:
:idprefix:
:idseparator: -
ifndef::env-github[:icons: font]
ifdef::env-github,env-browser[]
:toc: macro
:toclevels: 1
endif::[]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:!toc-title:
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]

=== shadowsocks
操作系统：CentOS6
安装shadowsocks服务端( link:https://github.com/shadowsocks/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E[参考官方Shadowsocks] )

===== 给服务器安装SS SERVER
----
yum -y install wget
wget --no-check-certificate https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks.sh
chmod +x shadowsocks.sh
./shadowsocks.sh 2>&1 | tee shadowsocks.log
----
[NOTE]
====
其他版本

wget -N --no-check-certificate https://softs.fun/Bash/ssrmu.sh && chmod +x ssrmu.sh && bash ssrmu.sh

wget -N --no-check-certificate https://raw.githubusercontent.com/ToyoDAdoubi/doubi/master/ssrmu.sh && chmod +x ssrmu.sh && bash ssrmu.sh
====


image::搭建vpn服务器\搭建vpn服务器-98ddf.png[]
提示你输入你的SS SERVER的密码和端口。建议你自己输入一个密码和端口(端口范围1-65536，推荐10000以上),如果不输入,系统会启用默认密码端口。然后按任意键继续

image::搭建vpn服务器\搭建vpn服务器-5b814.png[]
看到以上提示后就表明VPS上SS已经安装成功，并且已经设置了开机启动，VPS重启后不用手工启动SS

===== 编写配置（参考 link:https://github.com/shadowsocks/shadowsocks/wiki/Configuration-via-Config-File[Configuration] ）：

====== vi编辑配置
----
vi /etc/shadowsocks.json
----
====== 前台运行

  ssserver -c /etc/shadowsocks.json

====== 后台运行

  ssserver -c /etc/shadowsocks.json -d start
  ssserver -c /etc/shadowsocks.json -d stop

内容如下

----
{
    "server":"0.0.0.0",
    "server_port":8388,
    "local_address": "127.0.0.1",
    "local_port":1080,
    "password":"mypassword",
    "timeout":300,
    "method":"aes-256-cfb",
    "fast_open": false
}
----
或（多个SS账号）
----
{
    "server":"0.0.0.0",
    "port_password":{
     "8381":"xxxxxxx",
     "8382":"xxxxxxx",
     "8383":"xxxxxxx",
     "8384":"xxxxxxx"
     },
    "timeout":300,
    "method":"aes-256-cfb",
    "fast_open": false
}
----




===== 配置防火墙
若上面的配置成功后,客户端无法登入,则可能需要配置防火墙

如果服务器开了防火墙,则需要配置防火墙.若没有,请略过!

====== 查看所有端口 netstat
----
netstat -ntlp
----
image::搭建vpn服务器\搭建vpn服务器-9c461.png[]


====== iptables Centos 6
1.打开/关闭/重启防火墙
----
开启防火墙(重启后永久生效)：chkconfig iptables on
关闭防火墙(重启后永久生效)：chkconfig iptables off
开启防火墙(即时生效，重启后失效)：service iptables start
关闭防火墙(即时生效，重启后失效)：service iptables stop
重启防火墙:service iptables restartd
----
2.查看打开的端口
----
/etc/init.d/iptables status
----

3.打开某个端口(以8989为例)
----
iptables -A INPUT -p tcp --dport 8989 -j ACCEPT
----

另提一句

.打开49152~65534之间的端口
====
iptables -A INPUT -p tcp --dport 49152:65534 -j ACCEPT
====


4.保存并重启防火墙
----
/etc/rc.d/init.d/iptables save
/etc/init.d/iptables restart
----
5.其他打开方式

我们还可以通过修改/etc/sysconfig/iptables文件的方式开启端口，
然后在文件中增加一行
----
vi /etc/sysconfig/iptables
-A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 8080 -j ACCEPT
----
====
参数说明:

–A 参数就看成是添加一条规则

–p 指定是什么协议，我们常用的tcp 协议，当然也有udp，例如53端口的DNS

–dport 就是目标端口，当数据从外部进入服务器为目标端口

–sport 数据从服务器出去，则为数据源端口使用

–j 就是指定是 ACCEPT -接收 或者 DROP 不接收
====

====== firewalld Centos 7

Centos7默认安装了firewalld，如果没有安装的话，可以使用 yum install firewalld firewalld-config进行安装。

1.启动防火墙
----
systemctl start firewalld
----
2.禁用防火墙
----
systemctl stop firewalld
----
3.设置开机启动
----
systemctl enable firewalld
----
4.停止并禁用开机启动
----
sytemctl disable firewalld
----
5.重启防火墙
----
firewall-cmd --reload
----
6.查看状态
----
systemctl status firewalld或者 firewall-cmd --state
----
7.查看版本
----
firewall-cmd --version
----
8.查看帮助
----
firewall-cmd --help
----
9.查看区域信息
----
firewall-cmd --get-active-zones
----
10.查看指定接口所属区域信息
----
firewall-cmd --get-zone-of-interface=eth0
----
11.拒绝所有包
----
firewall-cmd --panic-on
----
12.取消拒绝状态
----
firewall-cmd --panic-off
----
13.查看是否拒绝
----
firewall-cmd --query-panic
----
14.将接口添加到区域(默认接口都在public)
----
firewall-cmd --zone=public --add-interface=eth0(永久生效再加上 --permanent 然后reload防火墙)
----
15.设置默认接口区域
----
firewall-cmd --set-default-zone=public(立即生效，无需重启)
----
16.更新防火墙规则
----
firewall-cmd --reload或firewall-cmd --complete-reload(两者的区别就是第一个无需断开连接，就是firewalld特性之一动态
添加规则，第二个需要断开连接，类似重启服务)
----
17.查看指定区域所有打开的端口
----
firewall-cmd --zone=public --list-ports
----
18.在指定区域打开端口（记得重启防火墙）
----
firewall-cmd --zone=public --add-port=80/tcp(永久生效再加上 --permanent)
----
====
说明：

–zone 作用域

–add-port=8080/tcp 添加端口，格式为：端口/通讯协议

–permanent #永久生效，没有此参数重启后失效
====


===== centos 6 更换系统内核kernel为2.6.32-504.el6.i686
首先需要确认自己的内核版本，输入命令uname -a
输出中有i686则为32位，有x86_64则为64位。

centos 6更换系统内核kernel为2.6.32-504.el6.i686的方法 以便支持锐速TCP加速软件

----
wget http://github.itzmx.com/1265578519/kernel/master/6.5/kernel-2.6.32-504.el6.x86_64.rpm -O kernel-2.6.32-504.el6.x86_64.rpm
rpm -ivh kernel-2.6.32-504.el6.x86_64.rpm --force
重启
reboot
----

备用下载服务器
----
wget http://ftp.scientificlinux.org/linux/scientific/6.5/x86_64/updates/security/kernel-2.6.32-504.el6.x86_64.rpm
rpm -ivh kernel-2.6.32-504.el6.x86_64.rpm --force
----
centos 7.1的
----
http://ftp.scientificlinux.org/linux/scientific/7.1/x86_64/updates/security/kernel-3.10.0-229.1.2.el7.x86_64.rpm
----

===== 锐速破解版安装方法

大概2月份的时候锐速宣布不再免费，原来宣传的永久免费20M也没了。一时间让广大vps爱好者陷入低谷，不过各路破解高手也是不断抛砖引玉，从开始的改MAC方法到后来的算lic方法，现在连一键安装包都出来了，算是比较成熟了吧。这里转载一个用的比较多的一键安装包，亲测可用，由91yun.org博主带来的。

脚本已托管在Github： https://github.com/91yun/serverspeeder

锐速破解版安装方法
----
wget -N --no-check-certificate https://github.com/91yun/serverspeeder/raw/master/serverspeeder.sh && bash serverspeeder.sh
----

锐速破解版卸载方法：
----
chattr -i /serverspeeder/etc/apx* && /serverspeeder/bin/serverSpeeder.sh uninstall -f
----
查看锐速启动状态
----
/serverspeeder/bin/serverSpeeder.sh status
----
